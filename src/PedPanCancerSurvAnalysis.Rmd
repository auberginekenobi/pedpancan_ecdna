---
title: "PedPanCancerSJSurvAnalysis + CBTNSurvAnalysis"
output: html_document
---
#load libraries
```{r}
library(tidyverse)
library(readxl)
library(dplyr)
library("stringr")
library(naniar) #for replace with Nas function
library("survival")
library("survminer")
library(RColorBrewer)
library(janitor)
```
#remove Nas in the OS Month and Status columns
```{r}
na_strings <- c("NA", "n/a", "Not Available", "Not Reported")
```
#CBTN survival data
```{r}
#Read in CBTN file
CBTNsurv <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/PedPanCancer_CBTN_SurvAnalysis.xlsx")

#Editing CBTN survival files
CBTNsurvallfiltered <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/PedPanCancer_CBTN_SurvAnalysis.xlsx", na = na_strings)
CBTNsurvallfiltered <- CBTNsurvallfiltered[!(is.na(CBTNsurvallfiltered$OS_Months)) & !(is.na(CBTNsurvallfiltered$OS_Status)),]

#CBTN - select cancer types that have at least one ecDNA sample
CBTNsurvallfiltered2 <- subset(CBTNsurvallfiltered, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")

#Plotting CBTN overall survival
CBTNfitecDNA <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = CBTNsurvallfiltered2)
plot(CBTNfitecDNA, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 295)", "ecDNA+ (n = 50)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = CBTNsurvallfiltered2) 
ggsurvplot(CBTNfitecDNA, conf.int=TRUE, pval=TRUE, risk.table=TRUE, 
           legend.labs=c("ecDNA-", "ecDNA+"), legend.title="ecDNA status",  
           palette=c("dodgerblue2", "orchid2"), 
           title="Kaplan-Meier Curve for Pediatric cancer survival by ecDNA status", 
           risk.table.height=.15)
summary(CBTNfitecDNA)
```
#SJ survival data
```{r}
#Read in SJ files
SJsurv <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/stjude/survival_data/SJ_SurvivalAnalysis.xlsx", na = na_strings)
Mastersurv <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/stjude/survival_data/SJ_SurvivalMaster.xlsx", na = na_strings)
#remove all blank spaces in my excel sheets (one excel pressed Ctrl+space and then find and replace, replaced space with nothing)

#merging the SJ survival data and the ecDNA data
SJsurvmerged <- left_join(SJsurv, Mastersurv, by="Sample_ID")
SJsurvmergedfilter <- SJsurvmerged[!(is.na(SJsurvmerged$"Overall Survival in Months")) & !(is.na(SJsurvmerged$"Survival Status")),]
#removing m from Overall Survival in Months
SJsurvmergedfilter$"Overall Survival in Months"<-gsub("m","",as.character(SJsurvmergedfilter$"Overall Survival in Months"))
SJsurvmergedfilter$"Survival Status"<-gsub("Expired","1",as.character(SJsurvmergedfilter$"Survival Status"))
SJsurvmergedfilter$"Survival Status"<-gsub("Alive","0",as.character(SJsurvmergedfilter$"Survival Status"))

#select only columns that are needed
SJsurvmergedfilter1 <- subset(SJsurvmergedfilter, select = c("Sample_ID", "Patient_ID", "tumor_type", "ecDNA", "Survival Status", "Overall Survival in Months"))
names(SJsurvmergedfilter1) = c("Sample_ID", "Patient_ID", "Cancer_Type_Abbrev", "ecDNA", "OS_Status", "OS_Months")

#select only tumor types that have at least 1 ecDNA sample
SJsurvmergedfilter2 <- subset(SJsurvmergedfilter1, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS"| Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")
#Converting OS_Months to integers
SJsurvmergedfilter2$OS_Months <- lapply(SJsurvmergedfilter2$OS_Months, as.integer)
#Converting integer to numeric
SJsurvmergedfilter2$OS_Months <- as.numeric(as.integer(SJsurvmergedfilter2$OS_Months))
SJsurvmergedfilter2$OS_Status <- as.numeric(as.character(SJsurvmergedfilter2$OS_Status))

#Determine duplicate patient values
dupes <- SJsurvmergedfilter2 %>% get_dupes(Patient_ID)

#select rows with unique patient IDs
SJsurvmergedfilter3 <- SJsurvmergedfilter2 %>% distinct(Patient_ID, .keep_all = TRUE)

#Adding OS censored at 5 yrs mark
SJsurvmergedfilter3 <- cbind(SJsurvmergedfilter3,SJsurvmergedfilter3[,5])
SJsurvmergedfilter3 <- cbind(SJsurvmergedfilter3,SJsurvmergedfilter3[,6])
names(SJsurvmergedfilter3) = c("Sample_ID", "Patient_ID", "Cancer_Type_Abbrev", "ecDNA", "OS_Status", "OS_Months", "OS_Status_5yrCensor", "OS_Months_5yrCensor")
SJsurvmergedfilter3$OS_Status_5yrCensor[SJsurvmergedfilter3$OS_Months >=60] <- 0
SJsurvmergedfilter3$OS_Months_5yrCensor[SJsurvmergedfilter3$OS_Months >=60] <- 60

#Plotting overall survival for SJ cohort 
SJfitecDNA <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = SJsurvmergedfilter3)
plot(SJfitecDNA, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 397)", "ecDNA+ (n = 75)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = SJsurvmergedfilter3) 
ggsurvplot(SJfitecDNA, conf.int=TRUE, pval=TRUE, risk.table=TRUE, 
           legend.labs=c("ecDNA-", "ecDNA+"), legend.title="ecDNA status",  
           palette=c("dodgerblue2", "orchid2"), 
           title="Kaplan-Meier Curve for Pediatric cancer survival by ecDNA status", 
           risk.table.height=.15)
summary(SJfitecDNA)

#Plotting overall survival for SJ cohort, censored at 5 yrs
SJfitecDNAcensor <- survfit(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA, data = SJsurvmergedfilter3)
plot(SJfitecDNAcensor, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 397)", "ecDNA+ (n = 75)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA, data = SJsurvmergedfilter3) 
ggsurvplot(SJfitecDNAcensor, conf.int=TRUE, pval=TRUE, risk.table=TRUE, 
           legend.labs=c("ecDNA-", "ecDNA+"), legend.title="ecDNA status",  
           palette=c("dodgerblue2", "orchid2"), 
           title="Kaplan-Meier Curve for Pediatric cancer survival by ecDNA status", 
           risk.table.height=.15)
summary(SJfitecDNAcensor)

#OS with Cancer Type as covariate
SJres.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = SJsurvmergedfilter3)
SJres.cox
ggforest(SJres.cox)

#relevel for LGG as reference
SJsurvmergedfilter3$Cancer_Type_Abbrev = relevel(as.factor(SJsurvmergedfilter3$Cancer_Type_Abbrev), ref = "LGG")
coxCancerType = coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = SJsurvmergedfilter3)
summary(coxCancerType)
pairwise_survdiff(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = SJsurvmergedfilter3, p.adjust.method = "BH")
ggforest(coxCancerType)
                           
#Survival analysis by each subgroup
#LGG
LGG <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "LGG")
fitecDNALGG <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = LGG)
plot(fitecDNALGG, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 7)", "ecDNA+ (n = 1)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = LGG) #p value = 0.7

#ACT
ACT <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "ACT")
fitecDNAACT <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = ACT)
plot(fitecDNAACT, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 0)", "ecDNA+ (n = 1)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = ACT) #no p value, only 1 sample total

#BT
BT <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "BT")
fitecDNABT <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = BT)
plot(fitecDNABT, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 50)", "ecDNA+ (n = 1)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = BT) #p value = 0.5

#HGG
HGG <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "HGG")
fitecDNAHGG <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = HGG)
plot(fitecDNAHGG, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 45)", "ecDNA+ (n = 6)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = HGG) #p value = 0.2

#MB
MB <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "MB")
fitecDNAMB <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = MB)
plot(fitecDNAMB, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 65)", "ecDNA+ (n = 13)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = MB) #p value = 0.8

#NBL
NBL <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "NBL")
fitecDNANBL <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = NBL)
plot(fitecDNANBL, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 39)", "ecDNA+ (n = 8)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = NBL) #p value = 0.9

#OS
OS <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "OS")
fitecDNAOS <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = OS)
plot(fitecDNAOS, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 33)", "ecDNA+ (n = 28)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = OS) #p value = 0.1

#RB
RB <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "RB")
fitecDNARB <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = RB)
plot(fitecDNARB, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 24)", "ecDNA+ (n = 6)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = RB) #p value = 0.6

#RHB
RHB <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "RHB")
fitecDNARHB <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = RHB)
plot(fitecDNARHB, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 20)", "ecDNA+ (n = 14)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = RHB) #p value = 0.6

#ST
ST <- subset(SJsurvmergedfilter2, Cancer_Type_Abbrev == "ST")
fitecDNAST <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = ST)
plot(fitecDNAST, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 66)", "ecDNA+ (n = 1)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = ST) #p value = 0.5
```
#Combining SJ and CBTN data
```{r}
#subsetting appropriate columns for CBTN
CBTNsubset <- subset(CBTNsurvallfiltered2, select = c("Patient_ID", "Cancer_Type_Abbrev", "ecDNA", "OS_Status", "OS_Months", "OS_Months_5yrCensor", "OS_Status_5yrCensor"))
SJsubset <- subset(SJsurvmergedfilter3, select = c("Patient_ID", "Cancer_Type_Abbrev", "ecDNA", "OS_Status", "OS_Months", "OS_Months_5yrCensor", "OS_Status_5yrCensor"))
combinedsurv <- rbind(CBTNsubset, SJsubset)
#saving combinedsurv as excel
library("writexl")
#write_xlsx(combinedsurv,"/Users/sunitasridhar/Desktop/Research/pedpancan/combinedsurv.xlsx")

#overall survival for combined cohort
fitcombined <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = combinedsurv)
plot(fitcombined, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 692)", "ecDNA+ (n = 125)"), col = c("red", "blue"), lty=c(1,1)) 
ggsurvplot(fitcombined, conf.int=TRUE, pval=TRUE, risk.table=TRUE, 
           legend.labs=c("ecDNA-", "ecDNA+"), legend.title="ecDNA status",  
           palette=c("dodgerblue2", "orchid2"), 
           title="Kaplan-Meier Curve for Pediatric cancer survival by ecDNA status", 
           risk.table.height=.15)
summary(fitcombined)
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = combinedsurv) #p value = 0.6

#overall survival for combined cohort at 5 yr censored
fitcombinedcensor <- survfit(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA, data = combinedsurv)
plot(fitcombinedcensor, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 692)", "ecDNA+ (n = 125)"), col = c("red", "blue"), lty=c(1,1)) 
ggsurvplot(fitcombinedcensor, conf.int=TRUE, pval=TRUE, risk.table=TRUE, 
           legend.labs=c("ecDNA-", "ecDNA+"), legend.title="ecDNA status",  
           palette=c("dodgerblue2", "orchid2"), 
           title="Kaplan-Meier Curve for Pediatric cancer survival by ecDNA status", 
           risk.table.height=.15)
summary(fitcombinedcensor)
survdiff(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA, data = combinedsurv) 

#Cox regression with ecDNA
combinedecDNAres.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA, data = combinedsurv)
combinedecDNAres.cox 
summary(combinedecDNAres.cox)
ggforest(combinedecDNAres.cox)


#Cox Regression with ecDNA and cancer type
combinedres.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = combinedsurv)
combinedres.cox 
ggforest(combinedres.cox)

test2 <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA * Cancer_Type_Abbrev, data = combinedsurv)
test2
ggforest(combinedres.cox)

test2 <- coxph(Surv(OS_Months, OS_Status) ~ factor(ecDNA) * factor(Cancer_Type_Abbrev) - 1, data = combinedsurv)
test2
ggforest(combinedres.cox)

test <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + strata(Cancer_Type_Abbrev), data = combinedsurv)
test
ggforest(combinedres.cox)

#relevel for LGG as reference
combinedsurv$Cancer_Type_Abbrev = relevel(as.factor(combinedsurv$Cancer_Type_Abbrev), ref = "LGG")
coxcombined = coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = combinedsurv)
summary(coxcombined)
pairwise_survdiff(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = combinedsurv, p.adjust.method = "BH")
ggforest(coxcombined)

#Survival analysis on cancer types with >=20 patients
cohort20 <- subset(combinedsurv, Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")
fitcohort20 <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = cohort20)
fitcohort20
plot(fitcohort20, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 682)", "ecDNA+ (n = 116)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = cohort20) #p value = 5 x 10^-7
cohort20cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = cohort20)
cohort20cox 
cohort20cox1 <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA * Cancer_Type_Abbrev, data = combinedsurv)
cohort20cox1

#combined kaplan meier for overlapping subgroups
#LGG
LGG <- subset(combinedsurv, Cancer_Type_Abbrev == "LGG")
fitecDNALGG <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = LGG)
plot(fitecDNALGG, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 69)", "ecDNA+ (n = 1)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = LGG) #p value = 0.2

#HGG
HGG <- subset(combinedsurv, Cancer_Type_Abbrev == "HGG")
fitecDNAHGG <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = HGG)
plot(fitecDNAHGG, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 118)", "ecDNA+ (n = 30)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = HGG) #p value = 0.1

#MB
MB <- subset(combinedsurv, Cancer_Type_Abbrev == "MB")
fitecDNAMB <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = MB)
plot(fitecDNAMB, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 139)", "ecDNA+ (n = 25)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = MB) #p value = 0.3

#NBL
NBL <- subset(combinedsurv, Cancer_Type_Abbrev == "NBL")
fitecDNANBL <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = NBL)
plot(fitecDNANBL, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 42)", "ecDNA+ (n = 9)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = NBL) #p value = 0.6

#RHB
RHB <- subset(combinedsurv, Cancer_Type_Abbrev == "RHB")
fitecDNARHB <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = RHB)
plot(fitecDNARHB, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 20)", "ecDNA+ (n = 13)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = RHB) #p value = 0.6

#ST
ST <- subset(combinedsurv, Cancer_Type_Abbrev == "ST")
fitecDNAST <- survfit(Surv(OS_Months, OS_Status) ~ ecDNA, data = ST)
plot(fitecDNAST, col = c("red", "blue"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=60, y=1, c("ecDNA- (n = 64)", "ecDNA+ (n = 2)"), col = c("red", "blue"), lty=c(1,1)) 
survdiff(Surv(OS_Months, OS_Status) ~ ecDNA, data = ST) #p value = 0.5
```
#comparing survival for cyclic amplicons versus non cyclic
```{r}
#Read in amplified gene data
ampanalysis <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/figures/PedPanCancerAmpAnalysis.xlsx")

#Obtain de duplicated samples to combine with survival data
get_deduplicated_biospecimens <- function(){
  #cbtn_bs_tbl <- read_excel("../data/PedPanCancer_CBTN_MasterAnalysis.xlsx",sheet="1b Samples")
  cbtn_bs_tbl <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/PedPanCancer_CBTNSurvAnalysisbySample.xlsx")
  cbtn_bs_tbl <- cbtn_bs_tbl %>%
    # the master table has trailing whitespace
  mutate(Specimen_ID = str_trim(Specimen_ID, side = "right")) %>% 
    # get rid of cell lines and relapsed samples
    filter(SAMPLE_TYPE == 'Solid Tissue') %>%
    # Ideally, we would do this programmatically, but I don't see sample collection date in our metadata
    filter(! Specimen_ID %in% c("SJHGG030230_R1", "SJHGG019_S", "SJRHB012_S", "SJST030043_D2", "SJOS001101_M8", "SJST030131_D3", "BS_X1DSETVE", "BS_3CG2N4PD", "BS_QMY84KF4", "BS_3E5C1PN1", "BS_WH8KWW5J", "BS_E1VJCEWB", "BS_C2NH5FDT", "BS_0TCRV9AC", "BS_TF5TTEXH", "BS_853PNV7P", "BS_00TRPEQX", "BS_1M63B97V", "BS_D368BNRD", "BS_RXSBJ929", "BS_S791VC80", "BS_5JC116NM", "BS_W37QBA12", "BS_DRVEFVQ5", "BS_VCE73HPW", "BS_B4PPG3X5", "BS_3Z40EZHD", "BS_4DYW3T2A", "BS_Z64NEPNE", "BS_KQRAHH6Y", "BS_HJ7HYZ7N", "BS_G65EA38C", "BS_JDZX545X", "BS_9P4NDTKJ", "BS_M0B42FPR", "BS_M5FM63EB", "BS_3VKW5988", "BS_5968GBGT", "BS_AF5D41PD", "BS_BQ81D2BP", "BS_EE73VE7V", "BS_0ATJ22QA", "BS_1Q524P3B", "BS_22VCR7DF", "BS_AK9BV52G", "BS_D6STCMQS", "BS_DVDT4VXQ", "BS_H8NWA41N", "BS_X5VN0FW0", "BS_R6CKWZW6", "BS_J8EH1N7V", "BS_Y74XAFJX", "BS_1MME7FBS", "BS_6JBE0947", "BS_AHAXPFG3", "BS_XQF18WZP", "BS_Q6GVRAWK", "BS_TQ0J7WJQ"))
  
  #sj_bs_tbl <- read_excel("../data/SJ_SurvivalAnalysis.xlsx",sheet="Sheet1")
  sj_bs_tbl <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/stjude/survival_data/SJ_SurvivalAnalysis.xlsx")
  sj_bs_tbl <- sj_bs_tbl %>%
    # We deduplicate the st jude data simply by sorting and deduplicating on the _D suffix.
    arrange(Sample_ID) %>%
    distinct(Patient_ID, .keep_all = TRUE)
  
  sample_list = c(cbtn_bs_tbl$Specimen_ID, sj_bs_tbl$Sample_ID)
  return(sample_list)
}
deduplicated_samples <- get_deduplicated_biospecimens()
deduplicated_amplicons <- ampanalysis %>% filter(sample_ID %in% deduplicated_samples)
# aggregate other tumor types into "other"
specific_tumor_types <- c("LGG", "ACT", "CPC", "ETMR", "CPG", "EP", "EPD", "GG", "HGG", "MB", "MPNST", "NBL", "NFP", "OS", "PB", "RB", "RHB")
deduplicated_amplicons <- deduplicated_amplicons %>%
  mutate(cancer_type = case_when(cancer_type %in% specific_tumor_types ~ cancer_type,
                                 TRUE ~ "other"))

ampanalysisfiltered1 <- subset(deduplicated_amplicons, select = c("sample_ID", "sample_name", "amplicon_type", "gene"))
names(ampanalysisfiltered1) = c("Sample_ID", "sample_name", "amplification_type", "gene")
```
#SJ cohort
```{r}
#Read in amplicon type data
SJamplicontype <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/stjude/PedPanCancer_StJude_MasterAnalysis_Copy.xlsx")
SJamplicontypesubset <- subset(SJamplicontype, select = c("Patient_ID", "amplicon_type"))

#Read in survival data
na_strings <- c("NA", "n/a", "Not Available", "Not Reported")
SJsurv <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/stjude/survival_data/SJ_SurvivalAnalysis.xlsx", na = na_strings)
Mastersurv <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/stjude/survival_data/SJ_SurvivalMaster.xlsx", na = na_strings)

#Merge survival data with patient IDs
SJsurvmerged <- complete(SJsurv, Sample_ID) %>%
    inner_join(., Mastersurv)

#Merge amplicon data with survival data
SJsurvmerged1 <- merge(SJsurvmerged, SJamplicontypesubset, by="Patient_ID")

SJsurvmerged1$"Overall Survival in Months"<-gsub("m","",as.character(SJsurvmerged1$"Overall Survival in Months"))
SJsurvmerged1$"Survival Status"<-gsub("Expired","1",as.character(SJsurvmerged1$"Survival Status"))
SJsurvmerged1$"Survival Status"<-gsub("Alive","0",as.character(SJsurvmerged1$"Survival Status"))

SJsurvmergedfilter1 <- subset(SJsurvmerged1, select = c("Sample_ID", "Patient_ID", "tumor_type", "ecDNA", "Survival Status", "Overall Survival in Months", "amplicon_type"))
names(SJsurvmergedfilter1) = c("Sample_ID", "Patient_ID", "Cancer_Type_Abbrev", "ecDNA", "OS_Status", "OS_Months", "amplicon_type")

SJsurvmergedfilter1$OS_Months <- lapply(SJsurvmergedfilter1$OS_Months, as.integer)
SJsurvmergedfilter1$OS_Months <- as.numeric(as.integer(SJsurvmergedfilter1$OS_Months))
SJsurvmergedfilter1$OS_Status <- as.numeric(as.character(SJsurvmergedfilter1$OS_Status))

SJsurvmergedfilter1 <- cbind(SJsurvmergedfilter1,SJsurvmergedfilter1[,5])
SJsurvmergedfilter1 <- cbind(SJsurvmergedfilter1,SJsurvmergedfilter1[,6])
names(SJsurvmergedfilter1) = c("Sample_ID", "Patient_ID", "Cancer_Type_Abbrev", "ecDNA", "OS_Status", "OS_Months", "amplicon_type", "OS_Status_5yrCensor", "OS_Months_5yrCensor")
SJsurvmergedfilter1$OS_Status_5yrCensor[SJsurvmergedfilter1$OS_Months >=60] <- 0
SJsurvmergedfilter1$OS_Months_5yrCensor[SJsurvmergedfilter1$OS_Months >=60] <- 60

#merge ampanalysis and survival data 
SJampsurv <- complete(SJsurvmergedfilter1, Sample_ID) %>%
    inner_join(., ampanalysisfiltered1)

#eliminate patients without survival data
SJampsurvfilter <- SJampsurv[!(is.na(SJampsurv$"OS_Months")) & !(is.na(SJampsurv$"OS_Status")),]

#Reorder columns
SJampsurvfilter1 <- SJampsurvfilter[,c(1,2,3,4,7,5,6,8,9,10,11,12)]

#eliminate duplicated patient IDs:this is tricky because will eliminate some genes for the same patient IDs, only can do survival analysis if separate out each gene individually.
#SJsurvmergedfilter2 <- SJsurvmergedfilter1 %>% distinct(Patient_ID, .keep_all = TRUE)
```
#CBTN cohort
```{r}
#reading in CBTN cohort with matched sample data
CBTNbysample <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/PedPanCancer_CBTNSurvAnalysisbySample.xlsx", na = na_strings)
#subsetting for desired columns
CBTNbysamplesubset <- subset(CBTNbysample, select = c("Specimen_ID", "Patient_ID", "ecDNA", "Cancer_Type", "OS_STATUS", "OS_MONTHS"))

#Reading in data with amplicon type
CBTNsurvallfiltered <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/PedPanCancer_CBTN_SurvAnalysis.xlsx", na = na_strings)
CBTNsurvallsubset <- subset(CBTNsurvallfiltered, select = c("Patient_ID","amplicon_type"))

#Editing data
CBTNbysamplesubset$"OS_STATUS"<-gsub("1:DECEASED","1",as.character(CBTNbysamplesubset$"OS_STATUS"))
CBTNbysamplesubset$"OS_STATUS"<-gsub("0:LIVING","0",as.character(CBTNbysamplesubset$"OS_STATUS"))

CBTNbysamplesubset <- cbind(CBTNbysamplesubset,CBTNbysamplesubset[,5])
CBTNbysamplesubset <- cbind(CBTNbysamplesubset,CBTNbysamplesubset[,6])
names(CBTNbysamplesubset) = c("Sample_ID", "Patient_ID", "ecDNA", "Cancer_Type_Abbrev","OS_Status", "OS_Months", "OS_Status_5yrCensor", "OS_Months_5yrCensor")
CBTNbysamplesubset$OS_Status_5yrCensor[CBTNbysamplesubset$OS_Months >=60] <- 0
CBTNbysamplesubset$OS_Months_5yrCensor[CBTNbysamplesubset$OS_Months >=60] <- 60

#merge amplicon type and CBTN survival data
CBTNampsurv <- complete(CBTNbysamplesubset, Patient_ID) %>%
    inner_join(., CBTNsurvallsubset) 

#merge ampanalysis and survival data 
CBTNampsurv1 <- complete(CBTNampsurv, Sample_ID) %>%
    inner_join(., ampanalysisfiltered1)

#removing rows w/o survival data
CBTNampsurvfiltered <- CBTNampsurv1[!(is.na(CBTNampsurv1$OS_Months)) & !(is.na(CBTNampsurv1$OS_Status)),]

#change order of dataframe for CBTN
CBTNampsurvfiltered <- CBTNampsurvfiltered[,c(1,2,4,3,9,5,6,7,8,10,11,12)]

#Keeping distinct patient IDs
#CBTNampsurvfiltered1 <- CBTNampsurvfiltered %>% distinct(Patient_ID, .keep_all = TRUE) #this is tricky because will eliminate some genes for the same patient IDs, only can do survival analysis if separate out each gene individually.

```
#join CBTN and SJ data
```{r}
AmpSurvAll <- rbind(CBTNampsurvfiltered, SJampsurvfilter1)
#change OS Status from character to numeric
AmpSurvAll$OS_Status <- as.numeric(as.character(AmpSurvAll$OS_Status))

#CBTN and SJ data joined including samples which lack survival data
AmpAll <- rbind(CBTNampsurv1, SJampsurv)
```
#Survival by amplicon type for combined SJ and CBTN data
```{r}
#combining CBTN and SJ data without the amplified gene data
AmpliconSurvAll <- rbind (CBTNampsurv, SJsurvmergedfilter1)
#change OS Status from character to numeric
AmpliconSurvAll$OS_Status <- as.numeric(as.character(AmpliconSurvAll$OS_Status))
AmpliconSurvAll$OS_Status_5yrCensor <- as.numeric(as.character(AmpliconSurvAll$OS_Status_5yrCensor))
#removing duplicate patient_IDs
AmpliconSurvAllfiltered <- AmpliconSurvAll %>% distinct(Patient_ID, .keep_all = TRUE)
#eliminate samples without survival data
AmpliconSurvAllfiltered1 <- AmpliconSurvAllfiltered[!(is.na(AmpliconSurvAllfiltered$OS_Months)) & !(is.na(AmpliconSurvAllfiltered$OS_Status)),]
#eliminate samples with cancer types that don't contain ecDNA
AmpliconSurvAllfiltered2 <- subset(AmpliconSurvAllfiltered1, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")

#survival by amplicon type for combined cohort censored at 5 years
fitamplicontype <- survfit(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = AmpliconSurvAllfiltered2)
plot(fitamplicontype, col = c("red", "blue", "green", "orange", "purple"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=30, y=1, c("cyclic", "complex non cyclic", "linear amplification", "no amplicon"), col = c("red", "blue", "green", "orange"), lty=c(1,1)) 
survdiff(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = AmpliconSurvAllfiltered2) 
amplicontypesurvplot <- ggsurvplot(fitamplicontype, conf.int=TRUE, pval=TRUE, risk.table=TRUE, 
           legend.labs=c("cyclic", "BFB", "complex non cyclic", "linear amplification", "no amplicon"), legend.title="amplicon status",  
           palette=c("red", "blue", "green", "orange", "purple"), 
           title="Kaplan-Meier Curve for Pediatric cancer survival by amplicon status", 
           risk.table.height=.15)
ggsurvplot(fitamplicontype)
summary(fitamplicontype)
fitamplicontypecox = coxph(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = AmpliconSurvAllfiltered2)
summary(fitamplicontypecox)
ggforest(fitamplicontypecox)
pairwise_survdiff(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = AmpliconSurvAllfiltered2, p.adjust.method = "BH")

#Changing reference to be no amplicon
AmpliconSurvAllfiltered2 <- within(AmpliconSurvAllfiltered2, {
  amplicon_type <- factor(amplicon_type, labels = c("cyclic", "BFB", "complex non cyclic", "linear amplification", "no amplicon"))
})
AmpliconSurvAllfiltered2$amplicon_type = relevel(as.factor(AmpliconSurvAllfiltered2$amplicon_type), ref = "no amplicon")
coxmodel <-
  coxph(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type,
    data = AmpliconSurvAllfiltered2 )
ggforest(coxmodel)

#Survival by amplicon type for combined cohort with cancer type as covariate
AmpliconSurvAllfiltered2 <- within(AmpliconSurvAllfiltered2, {
  amplicon_type <- factor(amplicon_type, labels = c("cyclic", "BFB", "complex non cyclic", "linear amplification", "no amplicon"))
})
AmpliconSurvAllfiltered2$amplicon_type = relevel(as.factor(AmpliconSurvAllfiltered2$amplicon_type), ref = "no amplicon")
coxmodel2 <-
  coxph(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type + Cancer_Type_Abbrev,
    data = AmpliconSurvAllfiltered2 )
ggforest(coxmodel2)

#survival by amplicon type for combined cohort w/o 60 month censoring
fitamplicontypeuncensored <- survfit(Surv(OS_Months, OS_Status) ~ amplicon_type, data = AmpliconSurvAllfiltered2)
ggsurvplot(fitamplicontypeuncensored)
summary(fitamplicontypeuncensored)
fitamplicontypecoxuncensored = coxph(Surv(OS_Months, OS_Status) ~ amplicon_type, data = AmpliconSurvAllfiltered2)
summary(fitamplicontypecoxuncensored)
ggforest(fitamplicontypecoxuncensored)
pairwise_survdiff(Surv(OS_Months, OS_Status) ~ amplicon_type, data = AmpliconSurvAllfiltered2, p.adjust.method = "BH")

#survival by amplicon type for CBTN cohort only
CBTNSurvAllfiltered <- CBTNampsurv %>% distinct(Patient_ID, .keep_all = TRUE)
#eliminate samples without survival data
CBTNSurvAllfiltered1 <- CBTNSurvAllfiltered[!(is.na(CBTNSurvAllfiltered$OS_Months)) & !(is.na(CBTNSurvAllfiltered$OS_Status)),]
CBTNSurvAllfiltered2 <- subset(CBTNSurvAllfiltered1, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")

fitamplicontypeCBTN <- survfit(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = CBTNSurvAllfiltered2)
plot(fitamplicontypeCBTN, col = c("red", "blue", "green", "orange", "purple"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=30, y=1, c("cyclic", "complex non cyclic", "linear amplification", "no amplicon"), col = c("red", "blue", "green", "orange"), lty=c(1,1)) 
survdiff(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = CBTNSurvAllfiltered2) 
amplicontypesurvplot <- ggsurvplot(fitamplicontypeCBTN, conf.int=TRUE, pval=TRUE, risk.table=TRUE, 
           legend.labs=c("cyclic", "BFB", "complex non cyclic", "linear amplification", "no amplicon"), legend.title="amplicon status",  
           palette=c("red", "blue", "green", "orange", "purple"), 
           title="Kaplan-Meier Curve for Pediatric cancer survival by amplicon status", 
           risk.table.height=.15)
ggsurvplot(fitamplicontypeCBTN)
summary(fitamplicontypeCBTN)
fitamplicontypecox = coxph(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = CBTNSurvAllfiltered2)
summary(fitamplicontypecox)
ggforest(fitamplicontypecox)
pairwise_survdiff(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = CBTNSurvAllfiltered2, p.adjust.method = "BH") 

#survival by amplicon type for SJ cohort only
SJSurvAllfiltered <- SJsurvmergedfilter1 %>% distinct(Patient_ID, .keep_all = TRUE)
#eliminate samples without survival data
SJSurvAllfiltered1 <- SJSurvAllfiltered[!(is.na(SJSurvAllfiltered$OS_Months)) & !(is.na(SJSurvAllfiltered$OS_Status)),]
#remove cancer types that dont have ecDNA
SJSurvAllfiltered2 <- subset(SJSurvAllfiltered1, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")

fitamplicontypeSJ <- survfit(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = SJSurvAllfiltered2)
plot(fitamplicontypeSJ, col = c("red", "blue", "green", "orange", "purple"), xlab = "Months", ylab="Survival", lwd = 2)
legend(x=30, y=1, c("cyclic", "complex non cyclic", "linear amplification", "no amplicon"), col = c("red", "blue", "green", "orange"), lty=c(1,1)) 
survdiff(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = SJSurvAllfiltered2) 
amplicontypesurvplot <- ggsurvplot(fitamplicontypeSJ, conf.int=TRUE, pval=TRUE, risk.table=TRUE, 
           legend.labs=c("cyclic", "BFB", "complex non cyclic", "linear amplification", "no amplicon"), legend.title="amplicon status",  
           palette=c("red", "blue", "green", "orange", "purple"), 
           title="Kaplan-Meier Curve for Pediatric cancer survival by amplicon status", 
           risk.table.height=.15)
ggsurvplot(fitamplicontypeSJ)
summary(fitamplicontypeSJ)
fitamplicontypecox = coxph(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = SJSurvAllfiltered2)
summary(fitamplicontypecox)
ggforest(fitamplicontypecox)
pairwise_survdiff(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ amplicon_type, data = SJSurvAllfiltered2, p.adjust.method = "BH") #Not significant?

#non 5 year censored data 
fitamplicontypeSJuncensored <- survfit(Surv(OS_Months, OS_Status) ~ amplicon_type, data = SJSurvAllfiltered2)
ggsurvplot(fitamplicontypeSJuncensored)
pairwise_survdiff(Surv(OS_Months, OS_Status) ~ amplicon_type, data = SJSurvAllfiltered2, p.adjust.method = "BH") #Not significant?
```
#Survival by amplification type without ranked amplification list
```{r}
#Read in amplicon classifier data
cbtn_bs_tbl <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/PedPanCancer_CBTN_MasterAnalysis_Copy.xlsx",sheet="1c AmpliconClassifier")
  cbtn_bs_tbl <- cbtn_bs_tbl %>%
    # the master table has trailing whitespace
  mutate(Sample_ID = str_trim(Sample_ID, side = "right")) %>% 
    # get rid of cell lines. Will keep the relapsed samples in this analysis
    # Ideally, we would do this programmatically, but I don't see sample collection date in our metadata
    filter(! Sample_ID %in% c("BS_CZRA594T", "BS_ERAWW3H7", "BS_PKZ1HWNB", "BS_FJEZ3ASV", "BS_68TZMZH1", "BS_AFBPM6CN", "BS_TX8C5VAJ", "BS_QWM9BPDY", "BS_HM5GFJN8", "BS_RXP2ZRQT", "BS_QZRP3NSG", "BS_DVDT4VXQ", "BS_6JBE0947", "BS_YZD4SSMA", "BS_M659G06J", "BS_VXDGXQKZ", "BS_ERFMPQN3", "BS_4DQAQFQH", "BS_XMP9XNR9", "BS_JGKRN7NA", "BS_853PNV7P", "BS_TF5TTEXH"))
  
  #TO DO - fix this data before i merge with survival by patient ID
  
#Read in survival data 
cbtnsurvival <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/PedPanCancer_CBTN_MasterAnalysis_Copy.xlsx",sheet="1b Samples", na = na_strings)
cbtnsurvival <- cbtnsurvival %>%
    # the master table has trailing whitespace
  mutate(Sample_ID = str_trim(Specimen_ID, side = "right")) %>% 
    # get rid of cell lines. Will keep the relapsed samples in this analysis
    # Ideally, we would do this programmatically, but I don't see sample collection date in our metadata
    filter(! Specimen_ID %in% c("BS_CZRA594T", "BS_ERAWW3H7", "BS_PKZ1HWNB", "BS_FJEZ3ASV", "BS_68TZMZH1", "BS_AFBPM6CN", "BS_TX8C5VAJ", "BS_QWM9BPDY", "BS_HM5GFJN8", "BS_RXP2ZRQT", "BS_QZRP3NSG", "BS_DVDT4VXQ", "BS_6JBE0947", "BS_YZD4SSMA", "BS_M659G06J", "BS_VXDGXQKZ", "BS_ERFMPQN3", "BS_4DQAQFQH", "BS_XMP9XNR9", "BS_JGKRN7NA", "BS_853PNV7P", "BS_TF5TTEXH"))
  
#subsetting for desired columns
cbtnsurvivalsubset <- subset(cbtnsurvival, select = c("Specimen_ID", "Patient_ID", "ecDNA", "Cancer_Type", "OS_STATUS", "OS_MONTHS"))
names(cbtnsurvivalsubset) <- c("Sample_ID", "Patient_ID", "ecDNA", "Cancer_Type", "OS_STATUS", "OS_MONTHS")

cbtnsurvivalsubset$"OS_STATUS"<-gsub("1:DECEASED","1",as.character(cbtnsurvivalsubset$"OS_STATUS"))
cbtnsurvivalsubset$"OS_STATUS"<-gsub("0:LIVING","0",as.character(cbtnsurvivalsubset$"OS_STATUS"))

cbtnsurvivalsubset <- cbind(cbtnsurvivalsubset,cbtnsurvivalsubset[,5])
cbtnsurvivalsubset <- cbind(cbtnsurvivalsubset,cbtnsurvivalsubset[,6])
names(cbtnsurvivalsubset) = c("Sample_ID", "Patient_ID", "ecDNA", "Cancer_Type","OS_Status", "OS_Months", "OS_Status_5yrCensor", "OS_Months_5yrCensor")
cbtnsurvivalsubset$OS_Status_5yrCensor[cbtnsurvivalsubset$OS_Months >=60] <- 0
cbtnsurvivalsubset$OS_Months_5yrCensor[cbtnsurvivalsubset$OS_Months >=60] <- 60

#Merge survival data and amplicon classifier data
CBTNampsurvival <- complete(cbtn_bs_tbl, Sample_ID) %>%
    inner_join(., cbtnsurvivalsubset) 

#merge ampanalysis and survival data 
CBTNampsurv1 <- complete(CBTNampsurv, Sample_ID) %>%
    inner_join(., ampanalysisfiltered1)

#removing rows w/o survival data
CBTNampsurvfiltered <- CBTNampsurv1[!(is.na(CBTNampsurv1$OS_Months)) & !(is.na(CBTNampsurv1$OS_Status)),]

#change order of dataframe for CBTN
CBTNampsurvfiltered <- CBTNampsurvfiltered[,c(1,2,4,3,9,5,6,7,8,10,11,12)]
  
  
  #sj_bs_tbl <- read_excel("../data/SJ_SurvivalAnalysis.xlsx",sheet="Sheet1")
  sj_bs_tbl <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/stjude/PedPanCancer_StJude_MasterAnalysis_Copy.xlsx",sheet = "1c Amplicon Classifier")
  sj_bs_tbl <- sj_bs_tbl %>%
    # We deduplicate the st jude data simply by sorting and deduplicating on the _D suffix.
    arrange(Sample_ID) %>%
    distinct(Patient_ID, .keep_all = TRUE)
  
  sample_list = c(cbtn_bs_tbl$Sample_ID, sj_bs_tbl$Sample_ID)
  return(sample_list)
}
deduplicated_samples <- get_deduplicated_biospecimens()
```


deduplicated_amplicons <- ampanalysis %>% filter(sample_ID %in% deduplicated_samples)
# aggregate other tumor types into "other"
specific_tumor_types <- c("LGG", "ACT", "CPC", "ETMR", "CPG", "EP", "EPD", "GG", "HGG", "MB", "MPNST", "NBL", "NFP", "OS", "PB", "RB", "RHB")
deduplicated_amplicons <- deduplicated_amplicons %>%
  mutate(cancer_type = case_when(cancer_type %in% specific_tumor_types ~ cancer_type,
                                 TRUE ~ "other"))

ampanalysisfiltered1 <- subset(deduplicated_amplicons, select = c("sample_ID", "sample_name", "amplicon_type", "gene"))
names(ampanalysisfiltered1) = c("Sample_ID", "sample_name", "amplification_type", "gene")

```
#Survival analysis for genes on circular vs non cyclic amplicons
```{r}
#subsetting MYCN amplified samples
MYCNsubset <- subset(AmpSurvAll, gene == "MYCN")
#remove duplicated sample
dupsample <- subset(MYCNsubset, sample_name == "SJNBL124_D_amplicon1" & amplification_type == "BFB_1")
MYCNsubset1 <- setdiff(MYCNsubset, dupsample)
#Survival analysis for MYCN subset
MYCNcox <- coxph(Surv(OS_Months, OS_Status) ~ amplification_type + Cancer_Type_Abbrev, data = MYCNsubset1)
MYCNcox #the N value is too small, meaningless!

#Survival analysis by gene 
genecox <- coxph(Surv(OS_Months, OS_Status) ~ gene, data = AmpSurvAll)
genecox

#removing samples that do not have at least one sample with ecDNA
```{r}
AmpSurvAll2 <- subset(AmpSurvAll1, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")

```
#Counting samples
```{r}
MYCNtots <- subset(AmpAll, gene == "MYCN" & amplification_type == "ecDNA_1")
```

####
DEADCODE
####

#combine different cancer types to see when it becomes significant
combinedsurv1 <- subset(combinedsurv, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")

interactionres.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA * Cancer_Type_Abbrev, data = combinedsurv)
interactionres.cox

#all Cancer Types
combinedallres.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = combinedsurv1)
combinedallres.cox
summary(combinedallres.cox)
ggforest(combinedallres.cox)
#remove GG (largest P value)
combinedsurv2 <- subset(combinedsurv1, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")
combinedGGres.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = combinedsurv2)
combinedGGres.cox
summary(combinedGGres.cox)
ggforest(combinedGGres.cox)

#remove RB
combinedsurv3 <- subset(combinedsurv1, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS" | Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")
combinedRBGGres.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = combinedsurv3)
combinedRBGGres.cox
summary(combinedRBGGres.cox)
ggforest(combinedRBGGres.cox)

res.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + Cancer_Type_Abbrev, data = combinedsurv)
res.cox
summary(combinedRBGGres.cox)
ggforest(combinedRBGGres.cox)

#Anova testing for looking at association of ecDNA and cancer type (not including survival data)
fit.aovcombined = aov(ecDNA ~ Cancer_Type_Abbrev, data = combinedsurv)
fit.aovcombined
TukeyHSD(fit.aovcombined)
fit.aovcombined1 = glm(ecDNA ~ Cancer_Type_Abbrev, data = combinedsurv, )
summary(fit.aovcombined1)
drop1(fit.aovcombined1, test = "F")

#ANOVA testing with omnibus test for ecDNA and cancer types (with caveat that this cohort has samples eliminated that do not have any survival data)
fit1 = anova(glm(ecDNA ~ Cancer_Type_Abbrev, data = combinedsurv, family = binomial), test = "Chisq")
fit1
fit2 = anova(lm(OS_Months ~ ecDNA * Cancer_Type_Abbrev, data = combinedsurv))
fit2





