---
title: "PedPanCancerAmpliconFigure"
output: html_document
---
#Load libraries
```{r}
library(here)
library(readxl)
library(ggplot2)
library(tidyverse)
library(janitor)
library(writexl)
library(cowplot)
library(extrafont)
library(svglite)

extrafont::font_import(pattern="Arial",prompt=FALSE)
extrafont::loadfonts()
```
#Read in combinedampliconsheet
```{r}
deduplicated_amplicons <- readxl::read_excel("../data/combinedamplicons.xlsx") # Modified from the "_gene_list.tsv" output of AmpliconClassifier
ecDNA_amplicons <- deduplicated_amplicons %>% filter(grepl("ecDNA", amplicon_type)) #Subset the ecDNA amplicons
COSMIC <- read.csv("../data/COSMIC_allgeneset.csv") # CSV file from https://cancer.sanger.ac.uk/census
```

#calculate total number of samples with amplification per gene per tumor type
```{r}
count_gene_amps <- function(ac_tbl){
# Count gene amplifications from AmpliconClassifier output.
# Expects as input the columns "sample_ID" "sample_name" "amplicon_number" "amplicon_type" "gene" "gene_cn" "truncated" "cancer_type" "database"
# Returns: matrix of gene counts of size n_cancer_type x m_genes
  ac_tbl <- ac_tbl %>% 
    group_by(cancer_type, gene) %>% 
    summarize(count = n(), .groups="keep")
  colnames(ac_tbl) <- c("cancertype","gene","total_frequency")
  ac_tbl <- ac_tbl %>%
    pivot_wider(
      names_from = cancertype,
      values_from = total_frequency
    )
  return(ac_tbl)
}
# gene_freq_all_amplicons <- count_gene_amps(deduplicated_amplicons)
gene_freq_ecDNA <- count_gene_amps(ecDNA_amplicons)
```

# Subset recurrently ecDNA-amplified oncogenes
```{r}
subset_recurrently_ecDNA_amp_genes <- function(freq_tbl){
  # tbl should be genes (rows) x tumor types (cols). See count_gene_amps.
  rowsums <- tibble(freq_tbl$gene, rowSums(freq_tbl[,-1], na.rm = TRUE))
  colnames(rowsums) <- c("gene","count")
  rowsums <- rowsums %>% 
    filter(count > 1) %>%
    filter(gene %in% COSMIC$gene)
  freq_tbl <- freq_tbl %>% 
    filter(gene %in% rowsums$gene) %>%
    janitor::remove_empty(which = "cols")
  return(freq_tbl)
}

gene_x_tumor_amp_freq <- subset_recurrently_ecDNA_amp_genes(gene_freq_ecDNA)
```

# Count ecDNA amplifications by gene
```{r}
gene_amp_freq <- tibble(gene_x_tumor_amp_freq$gene, rowSums(gene_x_tumor_amp_freq[,-1], na.rm = TRUE))
colnames(gene_amp_freq) <- c("gene","count")
gene_amp_freq
```
```{r}
cancer_order <- c("CPG","EP","ETMR","HGG","MB","NBL","OS","PB","RB","RHB","other")
chromosomal_gene_order <- c("PAX7","MYCN","FIP1L1","CHIC2","PDGFRA","KIT","KDR","TERT","TFEB","EGFR",
                            "CDK6","MET","RAD21","MYC","NDRG1","CCND1","BIRC3","CCND2","GLI1","DDIT3",
                            "CDK4","LRIG3","MDM2","PTPRB","FOXO1","RB1","GPC5","GAS7","NCOR1","FLCN",
                            "BRD4","CCNE1","TFPT","CNOT3")
```
#Integrated figure
```{r fig.height = 4, fig.width = 4}
# template @ https://rpubs.com/mgontar/215319

plot_gene_x_tumor_heatmap <- function(){
  gene_x_tumor_frequencytable   <- gene_x_tumor_amp_freq %>% 
    tidyr::pivot_longer(
      cols = CPG:other,
      names_to = c("cancertype"),
      values_to = "count"
    ) %>%
    mutate(cancertype = fct_relevel(cancertype, cancer_order))
  mapping <- aes(x = cancertype, y = gene, fill = count) #
  hm <- ggplot(data=gene_x_tumor_frequencytable, mapping=mapping) +
    geom_raster() +
    scale_fill_distiller(name = "Patient tumor count", palette = "Blues", direction = 1, na.value = "white", trans = 'log10', ) +
    scale_x_discrete() + 
    labs(x="Tumor type", y="Oncogene", tag="b") +
    theme_classic(base_size=7, base_family="Arial",) +
    theme(axis.text = element_text(size=7,colour="black"),
          plot.tag = element_text(size=8,face = "bold", colour = "black"),
          legend.position = "bottom", 
          legend.direction = "horizontal",
          legend.key.size = unit(1,"cm"),
          ) 
    #guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5))
  return(hm)
}

hm <- plot_gene_x_tumor_heatmap()
hm
```
```{r}
#subtracting legend
clean_heatmap <- function(hm){
  #tmp <- ggplot_gtable(ggplot_build(hm))
  #leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  #legend <- tmp$grobs[[leg]]
  
  #cleaning up heatmap without legend
  hm.clean <- hm +
      theme(axis.text = element_text(size=7,colour="black"),
            plot.tag = element_text(size=8,face = "bold", colour = "black"),
            legend.position="none")
  return(hm.clean)
}
hm.clean <- clean_heatmap(hm)
hm.clean
leg <- cowplot::get_legend(hm)
```
# Count samples represented in each column
```{r}
tumor_amp_freq <- ecDNA_amplicons %>%
  filter(gene %in% gene_x_tumor_amp_freq$gene) %>%
  distinct(sample_ID, .keep_all = TRUE) %>%
  group_by(cancer_type) %>%
  summarize(count = n()) %>%
  mutate(cancer_type = fct_relevel(cancer_type,cancer_order))
  
tumor_amp_freq
```
```{r fig.height = 3, fig.width = 4}
#creating x axis barplot
#Can use tumor_amp_freq

x_barplot <- function(color=TRUE){
  if(color){
    mapping <- aes(x = cancer_type, y = count, fill = count)
  }else{
    mapping <- aes(x = cancer_type, y = count)
  }
  bp.x <- ggplot(data = tumor_amp_freq, mapping = mapping) + 
    geom_bar(stat = "identity", mapping) + 
    theme_classic(base_size=7, base_family="Arial") + 
    #scale_y_log10() +
    #annotation_logticks(sides='l') +
    theme(
      axis.text = element_text(colour="black",size=7),
      plot.tag = element_text(size=8,face = "bold", colour = "black"),
      #axis.text.x = element_blank(),
      axis.title.x = element_blank(),
      #axis.ticks.x = element_blank(),
      legend.position = "none") + 
    scale_fill_distiller(name = "Value", palette = "Blues", direction = 1, trans = 'log10' ) + 
    labs(x = "Cancer Type", y = "Patient tumors with frequently\necDNA-amplified oncogenes", tag="a")
  return(bp.x)
  
  #bp.x.flip <- ggplot2::coord_flip(bp.x, "x")
}
bp.x <- x_barplot(color=FALSE)
bp.x
```
```{r fig.height = 4, fig.width = 4}
#creating y axis barplot
#can use gene_amp_freq
gene_amp_freq <- tibble(gene_x_tumor_amp_freq$gene, rowSums(gene_x_tumor_amp_freq[,-1], na.rm = TRUE))
colnames(gene_amp_freq) <- c("gene","count")
gene_amp_freq


y_barplot <- function(color=TRUE){
  if(color){
    mapping <- aes(x = count, y = gene, fill = count)
  }else{
    mapping <- aes(x = count, y = gene)
  }
  bp.y <- ggplot(data = gene_amp_freq, mapping=mapping) + 
    geom_col(stat = "identity", mapping=mapping) + 
    scale_x_log10() +
    annotation_logticks(sides='b') +
    theme_classic(base_size=7, base_family="Arial") + 
    theme(
      axis.text = element_text(colour="black",size=7),
      plot.tag = element_text(size=8,face = "bold", colour = "black"),
      #axis.text.y = element_blank(),
      axis.title.y = element_blank(),
      #axis.ticks.y = element_blank(),
      legend.position = "none") + 
    scale_fill_distiller(name = "Value", palette = "Blues", direction = 1, trans = 'log10' ) + 
    labs(x = "Patient tumors with frequently ecDNA-amplified oncogenes", tag="c")
  return(bp.y)
}
bp.y <- y_barplot(color=FALSE)
bp.y

```

```{r fig.height = 8, fig.width = 4}}
assemble_plot <- function(){
  cowplot::plot_grid(
    bp.x, leg, hm.clean, bp.y,
    align = "hv",
    axis = "lrbt",
    nrow=2,
    ncol=2,
    rel_heights=c(1,2)
  )
}
bp.y <- y_barplot(color=FALSE)
bp.x <- x_barplot(color=FALSE)

assemble_plot()
ggsave(filename="amplicon_plot_grey_bar.png",path="../out",dpi=300,width=7,height=7,units="in",bg="white")
ggsave(filename="amplicon_plot_grey_bar.svg",path="../out",dpi=300,width=7,height=7,units="in")
```
# Write outputs
```{r}
write_outputs <- function(filename){
  outdir <- file.path(here(),"out")
  dir.create(outdir, showWarnings = FALSE)
  path <- file.path(outdir,filename)
  write_xlsx(list(gene_x_tumor_amp_freq = gene_x_tumor_amp_freq, 
                  tumor_amp_freq = tumor_amp_freq,
                  gene_amp_freq = gene_amp_freq),
             path=path)
}
write_outputs("PedPanCancerAmpliconAnalysisOutputs.xlsx")
```


