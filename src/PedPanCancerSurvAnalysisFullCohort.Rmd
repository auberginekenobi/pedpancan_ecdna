---
title: "PedPanCancerSurvAnalysisFullCohort"
output: html_document
last updated: 10-29-2023
---
# DEFINITIONS
# 1 is death (event)     | R 1: Uncensored observation (event occurred)
# 0 is alive  (censored) | R 0: Censored observation.

theme_gtsummary_compact()

## Setting theme `Compact`

#load libraries
```{r}
library(tidyverse)
library(readxl)
library(dplyr)
library("stringr")
library(naniar) #for replace with Nas function
library("survival")
library("survminer")
library(RColorBrewer)
library(janitor)
pacman::p_load(tidyverse, rio, labelled)
pacman::p_load(gt, gtsummary)
pacman::p_load(bstfun)
pacman::p_load(survival, ggsurvfit)
pacman::p_load(ggsurvfit)
#devtools::install_github("MSKCC-Epi-Bio/bstfun") Had to install through devtools to get the bstfun package
```
#Read in combined cohort
```{r}
combinedsurv <- read_excel("/Users/sunitasridhar/Documents/GitHub/pedpancan_ecdna/data/combinedsurv.xlsx")
```
#Generating data table for full cohort
```{r}
dd <- combinedsurv %>% 
   mutate(ecDNA = factor(ecDNA_Status, labels = c('No','Yes')),
          Cancer_Type = factor(Cancer_Type_Abbrev))
var_label(dd) <- list(Cancer_Type = 'Cancer_Type_Abbrev')

# Cox regression for full cohort (for ecDNA status)
```{r}
m1 <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA + strata(Cancer_Type_Abbrev), data = dd)
m1

#inline forest plot for cox regression
m1 %>% 
   tbl_regression(
      exponentiate = TRUE,
      pvalue_fun = function(x) style_pvalue(x, digits = 2) 
   ) %>% 
   add_inline_forest_plot( 
      spec_pointrange.args = list(
         vline = 1,
         xlim = c(0, 10)
      )
   )

# KM by ecDNA status (not censored)
survfit2( Surv(OS_Months, OS_Status) ~ ecDNA_Status, data = dd ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()

# KM by ecDNA status censored at 5 years
survfit2( Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA_Status, data = dd ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()
```
#Subset for cancer types that have at least one sample with ecDNA
```{r}
#Subsetting data 
combinedsurvfiltered <- subset(combinedsurv, Cancer_Type_Abbrev == "ACT" | Cancer_Type_Abbrev == "BT" | Cancer_Type_Abbrev == "CPC" | Cancer_Type_Abbrev == "CPG" | Cancer_Type_Abbrev == "HGG" | Cancer_Type_Abbrev == "EP" | Cancer_Type_Abbrev == "ETMR" | Cancer_Type_Abbrev == "GG" | Cancer_Type_Abbrev == "LGG" | Cancer_Type_Abbrev == "MB" | Cancer_Type_Abbrev == "MPNST" | Cancer_Type_Abbrev == "MST" | Cancer_Type_Abbrev == "NBL" | Cancer_Type_Abbrev == "OS"| Cancer_Type_Abbrev == "PB" | Cancer_Type_Abbrev == "RB" | Cancer_Type_Abbrev == "RHB" | Cancer_Type_Abbrev == "ST")

#Generating data table
dd2 <- combinedsurvfiltered %>% 
   mutate(ecDNA = factor(ecDNA_Status, labels = c('No','Yes')),
          Cancer_Type = factor(Cancer_Type_Abbrev))
var_label(dd2) <- list(Cancer_Type = 'Cancer_Type_Abbrev')

#Cox regression for subsetted cohort
```{r}
m1 <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status + strata(Cancer_Type_Abbrev), data = dd2)
m1

# KM by ecDNA status for subsetted cohort
survfit2( Surv(OS_Months, OS_Status) ~ ecDNA_Status, data = dd2 ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()

# KM by ecDNA status censored at 5 years for subsetting cohort
survfit2( Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA_Status, data = dd2 ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()
```
