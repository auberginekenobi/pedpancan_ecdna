---
title: "PedPanCancerSurvAnalysisFullCohort"
output: html_document
last updated: 10-29-2023
---
# DEFINITIONS
# 1 is death (event)     | R 1: Uncensored observation (event occurred)
# 0 is alive  (censored) | R 0: Censored observation.

#load libraries
```{r}
## OSC check that all of these libraries are actually necessary to run this code. 
library(tidyverse)
library(readxl)
library(dplyr)
library("stringr")
library(naniar) #for replace with Nas function
library("survival")
library("survminer")
library(RColorBrewer)
library(janitor)
library(devtools)
pacman::p_load(tidyverse, rio, labelled)
pacman::p_load(gt, gtsummary)
pacman::p_load(bstfun)
pacman::p_load(survival, ggsurvfit)
pacman::p_load(ggsurvfit)
#devtools::install_github("MSKCC-Epi-Bio/bstfun") # Had to install through devtools to get the bstfun package
library(extrafont)
library(svglite)

extrafont::font_import(pattern="Arial",prompt=FALSE)
extrafont::loadfonts()
```
```{r}
## OSC create an output directory if it doesn't exist
dir.create('../out', showWarnings = FALSE)

load_survival_data <- function(path, tumor_types=NULL){
  ## path: path to data/Supplementary Tables.xlsx
  ## tumor_types: (optional) may specify only a subset of tumor types present in the dataset.
  combinedsurv <- read_excel(path, sheet="1. Patients")
  # Subset for tumor types if specified
  if (!is.null(tumor_types)){
    combinedsurv <- combinedsurv %>%
    filter(str_detect(cancer_type, tumor_types))
  }

  # Drop NAs
  combinedsurv <- combinedsurv %>%
    filter(complete.cases(amplicon_class,OS_status,OS_months)) %>%
  # Censor at 5 years = 60 months
    mutate(OS_months_5y = if_else(OS_months < 60, OS_months, 60)) %>%
    mutate(OS_status_5y = if_else(OS_months <= 60, OS_status, "Alive")) %>%
    mutate(OS_status_5y = if_else(OS_status_5y == "Alive", 0, 1)) %>%
  # get ecDNA status
    mutate(ecDNA_status = if_else(amplicon_class == "ecDNA", "ecDNA+", "ecDNA-")) %>%
  # convert to factors
    mutate(ecDNA_status = factor(ecDNA_status)) %>%
    mutate(amplicon_class = factor(amplicon_class)) %>%
    mutate(cancer_type = factor(cancer_type))
    
  return(combinedsurv)
}

old_load_survival_data <- function(path, tumor_types=NULL){
  ## OSC let's make a function to read in and preprocess the survival table.
  ## You could even parameterize it to subset for cancer types with at least 1 ecDNA+ sample, below.
  combinedsurv <- read_excel(path)
  if (!is.null(tumor_types)){
    combinedsurv <- combinedsurv %>%
    filter(str_detect(Cancer_Type_Abbrev, tumor_types))
  }
  dd <- combinedsurv %>% 
  mutate(ecDNA = factor(ecDNA_Status, labels = c('No','Yes')),
          Cancer_Type = factor(Cancer_Type_Abbrev))
  var_label(dd) <- list(Cancer_Type = 'Cancer_Type_Abbrev')
  return(dd)
}
cox_plot <- function(data,outfile){
  ## OSC function to perform a Cox regression and generate the plot
  coxph(Surv(OS_months, OS_status) ~ ecDNA_status + strata(cancer_type), data = data)
}
km_plot <- function(survObj,outfile=NULL){
  ## OSC function to perform a KM analysis and generate the plot
  if (length(survObj$n) == 2){
    colors = c('blue', 'red')
    labels = c('ecDNA-', 'ecDNA+')
  } else if (length(survObj$n) == 5){
    colors = c('magenta','darkgreen','red','cyan','dodgerblue')
    labels = c('BFB','Complex noncyclic','ecDNA','Linear','no fSCNA')
  } else if (length(survObj$n) == 4){
    colors = c('darkgreen','red','magenta','dodgerblue')
    labels = c('Highly rearranged','ecDNA','Linear','no fSCNA')
  }
  plt <- survObj %>% 
   ggsurvfit(linewidth=0.5) +
   labs(x = 'Follow-up time (Months)',
        y = 'Overall Survival') +
   scale_color_manual(values = colors,
                      labels = labels) +
   scale_fill_manual(values = colors,
                     labels = labels) +
   scale_y_continuous(limits=c(0, 1))+
   add_censor_mark(size = .5, alpha = 1) +
   add_risktable(risktable_stats = "n.risk", size=2,
                 theme = theme_risktable_default(axis.text.y.size = 7,
                                    plot.title.size = 7)) +
   add_risktable_strata_symbol(size=4) + 
   theme_classic(base_size=7, base_family="Arial",) +
   theme(axis.text = element_text(size=7,colour="black"),
         legend.position = "bottom",
   )
  if (length(survObj$n) <=2){
    plt <- plt + add_confidence_interval()
  }
  
  if(!is.null(outfile)){
    pdf.options(encoding='ISOLatin2.enc')
    pdfName = paste(outfile, ".pdf", sep="")
    pngName = paste(outfile, ".png", sep="")
    svgName = paste(outfile, ".svg", sep = "")
    ggsave(path="../out", filename=pdfName, device="pdf", width=3, height=3.5, units='in')
    ggsave(path="../out", device="png", filename=pngName, width=3, height=3.5, units='in')
    ggsave(path="../out", device="svg", filename=svgName, width=3, height=3.5, units='in')
  }
  return(plt)
}
```
# KM by ecDNA status of combined cohort, censored at 5 years
```{r}
print(getwd())
data <- load_survival_data("../data/Supplementary Tables.xlsx")
formula <- Surv(OS_months_5y, OS_status_5y) ~ ecDNA_status
km <- survfit2(formula=formula, data=data)
km_plot(km)
#km_plot(km, "km_surv_all_5year")
logrank <- survdiff(formula,data)
logrank
```
# KM by amplicon type
```{r}
data <- load_survival_data("../data/Supplementary Tables.xlsx") %>%
  mutate(amplicon_class = if_else(amplicon_class == "BFB", "Complex noncyclic", amplicon_class)) # merge BFB into CNC since there aren't a lot
formula <- Surv(OS_months_5y, OS_status_5y) ~ amplicon_class
km <- survfit2(formula=formula, data=data)
km_plot(km)
#km_plot(km, "km_class_all_5year")
logrank <- pairwise_survdiff(formula,data,p.adjust.method="BH")
logrank
```

# KM by ecDNA status of tumor types with at least 1 sample with ecDNA, censored at 5 years
```{r}
ec_tumors <- "ACT|BT|CPC|CPG|HGG|EP|ETMR|GG|LGG|MB|MPNST|MST|^NBL$|^OS$|PB|RB|RHB|ST"
dd2 <- load_survival_data("../data/combinedsurv.xlsx", ec_tumors)
km_plot(survfit2( Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA_Status, data = dd2 ), "km_surv_subset_5year")
```

Next, we perform a Cox regression w.r.t. ecDNA and tumor type. 
We include tumor types which satisfy the following:
- At least 10 patients
- At least one death
- At least one ecDNA
Furthermore, we exclude BT (Brain Tumor), ST (Solid Tumor) and MST (Metastasis) because these are catch-all
categories for tumors with various histologies. The final set of tumors to be analyzed is given in `cox_tumors`
```{R}
# Subset without rb and gg
cox_tumors <- "CPG|HGG|EP|LGG|MB|^NBL$|^OS$|RHB"

dd3 <-load_survival_data("../data/combinedsurv.xlsx", cox_tumors)
# Show contingency table
dd3 %>% group_by(ecDNA, Cancer_Type) %>%
  summarise(n=n())%>%
  spread(Cancer_Type, n)
m1_unstrat <- coxph(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA + Cancer_Type_Abbrev, data = dd3)
m1_unstrat
# Check proportionality assumption
coxZph <-cox.zph(m1_unstrat) 
print("coxZph: ")
print(coxZph)

```
The `cox.zph()` function tests the proportionality assumption. The result suggests that this assumption is
violated w.r.t. the Cancer_Type_Abbrev variable. 
Therefore, we perform Cox regression w.r.t. ecDNA, stratifying by Cancer_Type_Abbrev.

```{R}
m1 <- coxph(Surv(OS_Months_5yrCensor, OS_Status_5yrCensor) ~ ecDNA + strata(Cancer_Type_Abbrev), data = dd3)
m1
# Check proportionality assumption
coxZph <-cox.zph(m1) 
print("coxZph: ")
print(coxZph)
```
