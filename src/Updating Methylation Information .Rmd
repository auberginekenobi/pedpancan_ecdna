---
title: "Updating Methylation Information"
output: html_document
---
```{r}
#Read in libraries
library(tidyverse)
library(readxl)
library(dplyr)
library("stringr")
library(naniar) #for replace with Nas function
library("survival")
library("survminer")
library(RColorBrewer)
library(janitor)
```
#Read in files
```{r}
na_strings <- c("NA", "n/a", "Not Available", "Not Reported")
cbtnmaster <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/PedPanCancer_CBTN_MasterAnalysis_Copy.xlsx", sheet="1b Samples", na = na_strings)
histologies <- read_excel("/Users/sunitasridhar/Desktop/Research/pedpancan/cbtn/histologies-wgs-cohort.xlsx")
```
#Joining the two files for comparison
```{r}
#subsetting necessary columns
cbtnmasterfilter <- subset(cbtnmaster, select = c("Cancer_Type", "ecDNA", "Sample ID", "Specimen_ID"))
names(cbtnmasterfilter) <- c("Cancer_Type", "ecDNA_Status", "sample_id", "Specimen_ID")
cbtnmasterfilter <- cbtnmasterfilter[,c(3,1,2,4)]

#changing sample_id to numeric class
transform(cbtnmasterfilter, sample_id = as.character(sample_id))

#merging two datasets
cbtnhistologiesmerged <- left_join(cbtnmasterfilter, histologies, by="sample_id")

#Determine duplicate sample_ids - need to look through these samples, especially those with ecDNA +/-
test <- cbtnhistologiesmerged[duplicated(cbtnhistologiesmerged$sample_id), ]

#subset methylation data and my classifications to see if there is a difference
cbtnhistologiesmerged1 <- subset(cbtnhistologiesmerged, select = c("sample_id", "Cancer_Type", "ecDNA_Status", "Specimen_ID", "Kids_First_Participant_ID", "dkfz_v11_methylation_subclass", "dkfz_v12_methylation_subclass", "dkfz_v12_methylation_mgmt_status", "molecular_subtype", "integrated_diagnosis", "harmonized_diagnosis", "molecular_subtype_methyl"))

#subset EP data
#EPdata <- subset(cbtnhistologiesmerged1, Cancer_Type == "EP")
#EPdata1 <- subset(EPdata, harmonized_diagnosis == "Spinal ependymoma")

#EPdatatable <- subset(EPdata, select = c("Specimen_ID", "Kids_First_Participant_ID","harmonized_diagnosis"))

#subset HGG data which doesn't include survival data numbers
cbtnhistologiesmerged1 <- cbtnhistologiesmerged1 %>% distinct(sample_id, .keep_all = TRUE)
cbtnhistologiesmerged1 <- cbtnhistologiesmerged1 %>% distinct(Kids_First_Participant_ID, .keep_all = TRUE)
HGGdata <- subset(cbtnhistologiesmerged1, Cancer_Type == "HGG")
HGGdatatable <- subset(HGGdata, select = c("Specimen_ID", "Kids_First_Participant_ID","ecDNA_Status", "molecular_subtype"))
HGG1 <- subset(HGGdata, select = c("ecDNA_Status", "molecular_subtype"))
HGGtab <- table(HGG1)
HGGtab
```
#Survival plot for HGG
```{r}
#subsetting necessary columns
cbtnmasterfilter <- subset(cbtnmaster, select = c("Cancer_Type", "ecDNA", "Sample ID", "Specimen_ID", "OS_MONTHS","OS_STATUS", "AGE", "GENDER", "RACE", "SAMPLE_TYPE"))
names(cbtnmasterfilter) <- c("Cancer_Type_Abbrev", "ecDNA_Status", "sample_id", "Specimen_ID", "OS_Months", "OS_Status", "Age", "Gender", "Race", "SAMPLE_TYPE")
cbtnmasterfilter <- cbtnmasterfilter[,c(3,1,2,4,5,6,7,8,9,10)]

#changing sample_id to numeric class
transform(cbtnmasterfilter, sample_id = as.character(sample_id))

#merging two datasets
cbtnhistologiesmerged <- left_join(cbtnmasterfilter, histologies, by="sample_id")

#subset data
cbtnhistologiesmerged1 <- subset(cbtnhistologiesmerged, select = c("sample_id", "Cancer_Type_Abbrev", "ecDNA_Status", "Specimen_ID", "Kids_First_Participant_ID", "molecular_subtype", "OS_Months", "OS_Status", "Age", "Gender", "Race", "SAMPLE_TYPE"))

cbtnhistologiesmerged1filtered <- cbtnhistologiesmerged1[!(is.na(cbtnhistologiesmerged1$OS_Months)) & !(is.na(cbtnhistologiesmerged1$OS_Status)),]

get_deduplicated_biospecimens <- function(){
  cbtn_bs_tbl <- cbtnhistologiesmerged1filtered %>%
    # the master table has trailing whitespace
  mutate(Specimen_ID = str_trim(Specimen_ID, side = "right")) %>% 
    # get rid of cell lines etc
    filter(SAMPLE_TYPE == 'Solid Tissue') %>%
    # Remove relapsed samples -> Ideally, we would do this programmatically, but I don't see sample collection date in our metadata
    filter(! Specimen_ID %in% c("SJHGG030230_R1", "SJHGG019_S", "SJRHB012_S", "SJST030043_D2", "SJOS001101_M8", "SJST030131_D3", "BS_X1DSETVE", "BS_3CG2N4PD", "BS_QMY84KF4", "BS_3E5C1PN1", "BS_WH8KWW5J", "BS_E1VJCEWB", "BS_C2NH5FDT", "BS_0TCRV9AC", "BS_TF5TTEXH", "BS_853PNV7P", "BS_00TRPEQX", "BS_1M63B97V", "BS_D368BNRD", "BS_RXSBJ929", "BS_S791VC80", "BS_5JC116NM", "BS_W37QBA12", "BS_DRVEFVQ5", "BS_VCE73HPW", "BS_B4PPG3X5", "BS_3Z40EZHD", "BS_4DYW3T2A", "BS_Z64NEPNE", "BS_KQRAHH6Y", "BS_HJ7HYZ7N", "BS_G65EA38C", "BS_JDZX545X", "BS_9P4NDTKJ", "BS_M0B42FPR", "BS_M5FM63EB", "BS_3VKW5988", "BS_5968GBGT", "BS_AF5D41PD", "BS_BQ81D2BP", "BS_EE73VE7V", "BS_0ATJ22QA", "BS_1Q524P3B", "BS_22VCR7DF", "BS_AK9BV52G", "BS_D6STCMQS", "BS_DVDT4VXQ", "BS_H8NWA41N", "BS_X5VN0FW0", "BS_R6CKWZW6", "BS_J8EH1N7V", "BS_Y74XAFJX", "BS_1MME7FBS", "BS_6JBE0947", "BS_AHAXPFG3", "BS_XQF18WZP", "BS_Q6GVRAWK", "BS_TQ0J7WJQ"))
  
  sample_list = cbtn_bs_tbl$Specimen_ID
  return(sample_list)
}
deduplicated_samples <- get_deduplicated_biospecimens()
deduplicated_samples2 <- cbtnhistologiesmerged1filtered %>% filter(Specimen_ID %in% deduplicated_samples)
# aggregate other tumor types into "other"
specific_tumor_types <- c("LGG", "ACT", "CPC", "ETMR", "CPG", "EP", "EPD", "GG", "HGG", "MB", "MPNST", "NBL", "NFP", "OS", "PB", "RB", "RHB")
deduplicated_samples3 <- deduplicated_samples2 %>%
  mutate(Cancer_Type_Abbrev = case_when(Cancer_Type_Abbrev %in% specific_tumor_types ~ Cancer_Type_Abbrev))
deduplicated_samples3 <- deduplicated_samples3[!(is.na(deduplicated_samples3$Cancer_Type_Abbrev)),]

#Remove duplicate sample_id
deduplicated_samples4 <- deduplicated_samples3 %>% distinct(sample_id, .keep_all = TRUE)

#Editing survival info
deduplicated_samples4$"OS_Status"<-gsub("1:DECEASED","1",as.character(deduplicated_samples4$"OS_Status"))
deduplicated_samples4$"OS_Status"<-gsub("0:LIVING","0",as.character(deduplicated_samples4$"OS_Status"))

#Converting OS_Months to integers
deduplicated_samples4$OS_Months <- lapply(deduplicated_samples4$OS_Months, as.integer)
#Converting integer to numeric
deduplicated_samples4$OS_Months <- as.numeric(as.integer(deduplicated_samples4$OS_Months))
deduplicated_samples4$OS_Status <- as.numeric(as.character(deduplicated_samples4$OS_Status))

#Subset HGG subtypes
HGGdata <- subset(deduplicated_samples4, Cancer_Type_Abbrev == "HGG")

#Regrouping HGG subtypes
HGGdata %>%
 group_by(molecular_subtype)

HGGdata %>%
  group_by(molecular_subtype) %>%
  summarise(mean_subtype = n())

#creating new column with broader subtyping. Combined HGG NOS, IHG and IDH into HGG Other given low n in these groups
HGGdata <- cbind(HGGdata,HGGdata[,12])
names(HGGdata) = c("sample_id", "Cancer_Type_Abbrev", "ecDNA_Status", "Specimen_ID", "Kids_First_Participant_ID", "molecular_subtype", "OS_Months", "OS_Status", "Age", "Gender", "Race", "SAMPLE_TYPE", "broad_subtype")
HGGdata$broad_subtype[HGGdata$molecular_subtype == "DHG, H3 G35"] <- "H3 G35"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "DHG, H3 G35, TP53"] <- "H3 G35"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "DMG, H3 K28"] <- "H3 K27"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "DMG, H3 K28, TP53"] <- "H3 K27"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "HGG, H3 wildtype"] <- "H3 WT"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "HGG, H3 wildtype, TP53"] <- "H3 WT"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "IHG, ROS1-altered, TP53"] <- "HGG Other"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "IHG, NTRK-altered"] <- "HGG Other"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "HGG, IDH, TP53"] <- "HGG Other"
HGGdata$broad_subtype[HGGdata$molecular_subtype == "HGG, To be classified"] <- "HGG Other"

#summary values
agg_tbl <- HGGdata %>% group_by(ecDNA_Status, broad_subtype) %>% 
  summarise(mean_subtype = n())
agg_tbl
```
#HGG subtype analysis by molecular_subtype
```{r}
pacman::p_load(tidyverse, rio, labelled)
pacman::p_load(gt, gtsummary)
?pacman::p_load(bstfun)
pacman::p_load(survival, ggsurvfit)
```
```{r}
#for molecular subtype
dd <- HGGdata %>% 
   mutate(ecDNA = factor(ecDNA_Status, labels = c('No','Yes')),
          molecular_subtype = factor(molecular_subtype))
var_label(dd) <- list(molecular_subtype = 'Molecular Subtype')

#for broad molecular subtype (divide in HGG WT, H3 Mut, Other to help with power)
dd2 <- HGGdata %>% 
   mutate(ecDNA = factor(ecDNA_Status, labels = c('No','Yes')),
          molecular_subtype = factor(broad_subtype))
var_label(dd2) <- list(broad_subtype = 'Molecular Subtype')
```
# DEFINITIONS
# 1 is death (event)     | R 1: Uncensored observation (event occurred)
# 0 is alive  (censored) | R 0: Censored observation.

theme_gtsummary_compact()

## Setting theme `Compact`

# TABLE 1 BY ecDNA
```{r}
#molecular subtype
dd %>% 
   tbl_summary(by = ecDNA,
               include = c(molecular_subtype, OS_Months, OS_Status),
               sort = list(molecular_subtype ~ 'frequency')) %>% 
   add_overall() %>% 
   add_p( test = list(molecular_subtype ~ 'chisq.test'),
          pvalue_fun = function(x) style_pvalue(x, digits = 2) )

#broader molecular subtyping
dd2 %>% 
   tbl_summary(by = ecDNA,
               include = c(broad_subtype, OS_Months, OS_Status),
               sort = list(broad_subtype ~ 'frequency')) %>% 
   add_overall() %>% 
   add_p( test = list(broad_subtype ~ 'chisq.test'),
          pvalue_fun = function(x) style_pvalue(x, digits = 2) )

# TABLE 1 BY OS_Status
```{r}
#molecular subtyping
dd %>% 
   mutate(OS_Status = factor(OS_Status, labels = c('0-Alive','1-Death'))) %>% 
   tbl_summary(by = OS_Status,
               include = c(molecular_subtype, OS_Months, ecDNA_Status),
               sort = list(molecular_subtype ~ 'frequency')) %>% 
   add_overall() %>% 
   add_p( test = list(molecular_subtype ~ 'chisq.test'),
          pvalue_fun = function(x) style_pvalue(x, digits = 2) )

#broader molecular subtyping
dd2 %>% 
   mutate(OS_Status = factor(OS_Status, labels = c('0-Alive','1-Death'))) %>% 
   tbl_summary(by = OS_Status,
               include = c(broad_subtype, OS_Months, ecDNA_Status),
               sort = list(broad_subtype ~ 'frequency')) %>% 
   add_overall() %>% 
   add_p( test = list(broad_subtype ~ 'chisq.test'),
          pvalue_fun = function(x) style_pvalue(x, digits = 2) )
```
```{r}
#molecular subtype
id <- dd %>%
   filter(ecDNA_Status == 'Yes') %>% 
   count(molecular_subtype) %>%
   arrange(desc(n)) %>% 
   filter(n > 0) %>% pull(molecular_subtype)

dd %>% 
   filter(molecular_subtype %in% id) %>% 
   droplevels() %>% 
   tbl_summary(by = ecDNA_Status,
               include = c(molecular_subtype, OS_Months, OS_Status),
               sort = list(molecular_subtype ~ 'frequency')) %>% 
   add_overall() %>% 
   add_p( test = list(molecular_subtype ~ 'chisq.test'),
          pvalue_fun = function(x) style_pvalue(x, digits = 2) )

#broader molecular subtype
id2 <- dd2 %>%
   filter(ecDNA_Status == 'Yes') %>% 
   count(broad_subtype) %>%
   arrange(desc(n)) %>% 
   filter(n > 0) %>% pull(broad_subtype)

dd2 %>% 
   filter(broad_subtype %in% id2) %>% 
   droplevels() %>% 
   tbl_summary(by = ecDNA_Status,
               include = c(broad_subtype, OS_Months, OS_Status),
               sort = list(broad_subtype ~ 'frequency')) %>% 
   add_overall() %>% 
   add_p( test = list(broad_subtype ~ 'chisq.test'),
          pvalue_fun = function(x) style_pvalue(x, digits = 2) )

# MODEL 1

```{r}
#cant figure out how to add in this inline forest plot function
knitr::read_chunk('/Users/sunitasridhar/Desktop/Research/pedpancan/Figures/Updated Figures/inlineforestplot script.R')
library(gtsummary)
library(forestplot)
```
#cox regression
```{r}
m1 <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status + strata(molecular_subtype), data = dd)
m1

m1 %>% 
   tbl_regression(
      exponentiate = TRUE,
      pvalue_fun = function(x) style_pvalue(x, digits = 2) 
   ) %>% 
   add_inline_forest_plot( 
      spec_pointrange.args = list(
         vline = 1,
         xlim = c(0, 10)
      )
   )

m2 <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status + strata(broad_subtype), data = dd2)
m2
```
# Plot Cox Regression
```{r}
pacman::p_load(ggsurvfit)

# KM by ecDNA status for HGG subgroup
survfit2( Surv(OS_Months, OS_Status) ~ ecDNA_Status, data = dd ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()

survfit2( Surv(OS_Months, OS_Status) ~ molecular_subtype, data = dd ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()

survfit2( Surv(OS_Months, OS_Status) ~ ecDNA_Status + molecular_subtype, data = dd ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()

survfit2( Surv(OS_Months, OS_Status) ~ broad_subtype, data = dd2 ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()

survfit2( Surv(OS_Months, OS_Status) ~ ecDNA_Status + broad_subtype, data = dd2 ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_confidence_interval() +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()

survfit2( Surv(OS_Months, OS_Status) ~ ecDNA_Status + broad_subtype, data = dd2 ) %>% 
   ggsurvfit() +
   labs(x = 'Follow-up time (Months)',
        y = 'Survival Probability') +
   add_censor_mark(size = 2, alpha = 0.2) +
   add_risktable(risktable_stats = "n.risk") +
   add_risktable_strata_symbol()

res.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status + molecular_subtype, data = HGGdata)
res.cox
ggforest(res.cox)

res.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status * molecular_subtype, data = HGGdata)
res.cox
ggforest(res.cox)

pairwise_survdiff(Surv(OS_Months, OS_Status) ~ ecDNA_Status + molecular_subtype, data = dd, p.adjust.method = "BH")

res.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status + broad_subtype, data = HGGdata)
res.cox
ggforest(res.cox)

#change reference to be HGG other
HGGdata$broad_subtype = relevel(as.factor(HGGdata$broad_subtype), ref = "HGG Other")
coxmodel <-
  coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status + broad_subtype,
    data = HGGdata )
ggforest(coxmodel)

pairwise_survdiff(Surv(OS_Months, OS_Status) ~ ecDNA_Status + broad_subtype, data = HGGdata, p.adjust.method = "BH")

```
#HGG analysis with broader subtyping
```{r}
res.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status + broad_subtype, data = HGGdata)
res.cox

res.cox <- coxph(Surv(OS_Months, OS_Status) ~ ecDNA_Status * broad_subtype, data = HGGdata)
res.cox
```
#Sankey diagrams
```{r}
#TO DO: Create Sankey Diagram to represent change in tumor classification over methylation classifier:
#Code from https://rpubs.com/oomiwale1/926103
#Additional code: https://rpubs.com/techanswers88/sankey-with-own-data-in-ggplot
#https://rdrr.io/github/davidsjoberg/ggsankey/man/theme_sankey.html
```
#Creating Sankey plot from ALL the data (extremely messy)
```{r}
#install.packages("remotes")
#remotes::install_github("davidsjoberg/ggsankey")
library(ggsankey)
df <- cbtnhistologiesmerged1 %>%
  make_long(Cancer_Type, dkfz_v11_methylation_subclass, dkfz_v12_methylation_subclass, integrated_diagnosis, molecular_subtype)

library(ggplot2)
library(dplyr)

pl <- ggplot(df, aes(x = x,                        
                     next_x = next_x,                                     
                     node = node,
                     next_node = next_node,        
                     fill = factor(node),
                     label = node))

pl <- pl +geom_sankey(flow.alpha = 0.5,          #This Creates the transparency of your node 
                      node.color = "black",     # This is your node color        
                      show.legend = TRUE) 
#Adding labels
pl <- pl + geom_sankey_label(Size = 3, 
                             color = "black", 
                             fill = "white") # This specifies the Label format for each node 


pl <- pl + theme_bw()
pl <- pl + theme(legend.position = 'none')
pl <- pl + theme(axis.title = element_blank(),
                 axis.text.y = element_blank(),
                 axis.ticks = element_blank(),
                 panel.grid = element_blank())

pl <- pl + scale_fill_viridis_d(option = "inferno")
pl <- pl + labs(title = "Creating a Sankey Diagram")
pl <- pl + labs(subtitle = "Using tumor classification data")
pl <- pl + labs(caption ="Sunita Sridhar" )
pl <- pl + labs(fill = 'Nodes')
pl
#ggsave(file = "sankeyplot.jpg", pl)
```
#Creating sankey plot with only tumor types that have ecDNA
```{r}
#subset only tumor types that have ecDNA
cbtnhistologiesmerged2 <- subset(cbtnhistologiesmerged1, Cancer_Type == "ACT" | Cancer_Type == "BT" | Cancer_Type == "CPC" | Cancer_Type == "CPG" | Cancer_Type == "HGG" | Cancer_Type == "EP" | Cancer_Type == "ETMR" | Cancer_Type == "GG" | Cancer_Type == "LGG" | Cancer_Type == "MB" | Cancer_Type == "MPNST" | Cancer_Type == "MST" | Cancer_Type == "NBL" | Cancer_Type == "OS" | Cancer_Type == "PB" | Cancer_Type == "RB" | Cancer_Type == "RHB" | Cancer_Type == "ST")

df2 <- cbtnhistologiesmerged2 %>%
  make_long(dkfz_v12_methylation_subclass, Cancer_Type, molecular_subtype)

pl <- ggplot(df2, aes(x = x,                        
                     next_x = next_x,                                     
                     node = node,
                     next_node = next_node,        
                     fill = factor(node),
                     label = node))

pl <- pl +geom_sankey(flow.alpha = 0.5,          #This Creates the transparency of your node 
                      node.color = "black",     # This is your node color        
                      show.legend = TRUE)  # This determines if you want your legend to show
#Adding labels
pl <- pl + geom_sankey_text(size = 1, 
                             color = "black", 
                             hjust = -0.5) # This specifies the Label format for each node 
#pl <- pl +geom_sankey_label(size = 2, color = "black", fill= "white", hjust = -0.1) #changed to text from label

pl <- pl + theme_bw()
base_size = 5
pl <- pl + theme_sankey(base_size = base_size, 
                        base_family = "",
                        base_line_size = base_size/22,
                        base_rect_size = base_size/22)
pl <- pl + theme(legend.position = 'none')
pl <- pl + theme(axis.title = element_blank(),
                 axis.text.y = element_blank(),
                 axis.ticks = element_blank(),
                 panel.grid = element_blank())

pl <- pl + scale_fill_viridis_d(option = "inferno")
pl <- pl + labs(title = "Creating a Sankey Diagram")
pl <- pl + labs(subtitle = "Using tumor classification data")
pl <- pl + labs(caption ="Sunita Sridhar" )
pl <- pl + labs(fill = 'Nodes')
pl
ggsave(file = "sankeyplot1.jpg", pl)

```
```{r}
#subset only ETMR tumor type
cbtnhistologiesmergedETMR <- subset(cbtnhistologiesmerged1, Cancer_Type == "ETMR")

df3 <- cbtnhistologiesmergedETMR %>%
  make_long(Kids_First_Participant_ID, Cancer_Type, dkfz_v11_methylation_subclass, dkfz_v12_methylation_subclass, integrated_diagnosis, harmonized_diagnosis)

pl <- ggplot(df3, aes(x = x,                        
                     next_x = next_x,                                     
                     node = node,
                     next_node = next_node,        
                     fill = factor(node),
                     label = node))

pl <- pl +geom_sankey(flow.alpha = 0.3,          #This Creates the transparency of your node 
                      node.color = "black",     # This is your node color        
                      show.legend = TRUE) 

#Adding labels to the nodes

pl <- pl + geom_sankey_label(size = 2,
                             color = "black", 
                             fill = "white", 
                             hjust = 0.5) # This specifies the Label format for each node 

pl <- pl + theme_bw()
pl <- pl + theme(legend.position = 'none')
pl <- pl + theme(axis.title = element_blank(),
                 axis.text.y = element_blank(),
                 axis.ticks = element_blank(),
                 panel.grid = element_blank())

pl <- pl + scale_fill_viridis_d(option = "inferno")
pl <- pl + labs(title = "Creating a Sankey Diagram")
pl <- pl + labs(subtitle = "Using tumor classification data")
pl <- pl + labs(caption ="Sunita Sridhar" )
pl <- pl + labs(fill = 'Nodes')
pl

#Code to add percentage on the nodes
#Step 1
df3 <- cbtnhistologiesmergedETMR %>%
  make_long(Kids_First_Participant_ID, Cancer_Type, dkfz_v11_methylation_subclass, dkfz_v12_methylation_subclass, molecular_subtype, integrated_diagnosis, harmonized_diagnosis)

TotalCount = nrow(df3)

#Step 2
reagg <- df3%>%
  dplyr::group_by(node)%>%  # Here we are grouping the data by node and then we are taking the frequency of it 
  tally()

reagg <- reagg%>%
  dplyr::group_by(node)%>%  # Here we are grouping the data by node and then we are taking the frequency of it 
  dplyr::mutate(pct = n/TotalCount)

df4 <- merge(df3,
             reagg, 
             by.x = 'node', 
             by.y = 'node', 
             all.x = TRUE)

pl <- ggplot(df4, aes(x = x,                        
                     next_x = next_x,                                     
                     node = node,
                     next_node = next_node,        
                     fill = factor(node),
                     label = paste0(node," n=", n, '(',  round(pct* 100,1), '%)' )))             # This Creates a label for each node
                     
pl <- pl +geom_sankey(flow.alpha = 0.8,          #This Creates the transparency of your node 
                      node.color = "black",     # This is your node color        
                      show.legend = TRUE)        # This determines if you want your legend to show

pl <- pl + geom_sankey_label(size = 2,
                             color = "black", 
                             fill = "white", 
                             hjust = 0.5) # This specifies the Label format for each node 


pl <- pl + theme_bw()
pl <- pl + theme(legend.position = 'none')
pl <- pl + theme(axis.title = element_blank(),
                 axis.text.y = element_blank(),
                 axis.ticks = element_blank(),
                 panel.grid = element_blank())
base_size = 5
pl <- pl + theme_sankey(base_size = base_size, 
                        base_family = "",
                        base_line_size = base_size/22,
                        base_rect_size = base_size/22)
pl <- pl + scale_fill_viridis_d(option = "inferno")
pl <- pl + labs(title = "Creating a Sankey Diagram")
pl <- pl + labs(subtitle = "Using tumor classification data")
pl <- pl + labs(caption ="Sunita Sridhar" )
pl <- pl + labs(fill = 'Nodes')
pl

#ggsave(file = "sankeyplot2.jpg", pl)

```
#Obtaining Age, Sex, Ethinicity, Race parameters for cohort
```{r}
 #subsetting necessary columns
cbtnmasterfilter <- subset(cbtnmaster, select = c("Cancer_Type", "ecDNA", "Sample ID", "Specimen_ID", "AGE", "GENDER", "ETHNICITY", "RACE"))
names(cbtnmasterfilter) <- c("Cancer_Type", "ecDNA_Status", "sample_id", "Specimen_ID","AGE", "GENDER", "ETHNICITY", "RACE")
cbtnmasterfilter <- cbtnmasterfilter[,c(3,1,2,4,5,6,7,8)]

#changing sample_id to character class
transform(cbtnmasterfilter, sample_id = as.character(sample_id))

#Obtain unique patients
cbtnmasterfilter1 <- cbtnmasterfilter[!duplicated(cbtnmasterfilter$sample_id), ]

#Determine average age across cohort
cbtnmasterfilter1$AGE <- as.numeric(cbtnmasterfilter1$AGE)
cbtnmasterfilter1 <- na.omit(cbtnmasterfilter1)
mean(cbtnmasterfilter1$AGE)

#Determine gender distribution across cohort
sum(cbtnmasterfilter1$GENDER=="Female")
sum(cbtnmasterfilter1$GENDER=="Male")
cbtnmasterfilter1 %>%
 group_by(GENDER) %>%
 summarise(gender_count=n())
table <- table(cbtnmasterfilter1$GENDER)
prop.table(table)

#Determine ethnicity distribution across cohort
ethnicitytable <- table(cbtnmasterfilter1$ETHNICITY)
prop.table(ethnicitytable)
cbtnmasterfilter1 %>%
 group_by(ETHNICITY) %>%
 summarise(gender_count=n())

#Determine race distribution across cohort
cbtnmasterfilter1 %>%
 group_by(RACE) %>%
 summarise(race_count=n())
racetable <- table(cbtnmasterfilter1$RACE)
prop.table(racetable)
```
 
 
 
 
 


